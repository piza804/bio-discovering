<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
<style>
body { font-family: Arial, sans-serif; background: #f5f5f5; margin:0; padding:0; display:flex; flex-direction:column; align-items:center; font-size:18px; }
h1 { margin-top:20px; font-size:2em; }
#camera-container { width:100%; max-width:600px; margin-top:20px; position:relative; }
#barcode-result { text-align:center; margin-top:10px; font-weight:bold; font-size:1.4em; }
#form-container { display:none; background:white; padding:20px; border-radius:10px; box-shadow:0 3px 12px rgba(0,0,0,0.2); margin-top:20px; width:90%; max-width:600px; }
#form-container input, #form-container button { width:100%; padding:12px; margin-top:12px; font-size:1.2em; }
#form-container button { background:#4CAF50; color:white; border:none; border-radius:6px; cursor:pointer; }
#form-container button:hover { background:#45a049; }
#inventory-table { width:90%; max-width:800px; margin-top:30px; border-collapse: collapse; }
#inventory-table th, #inventory-table td { border:1px solid #ccc; padding:10px; text-align:center; font-size:1.1em; }
#inventory-table th { background:#e0e0e0; }
.out-btn { background:#f44336; color:white; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
.out-btn:hover { background:#d32f2f; }
</style>
</head>
<body>

<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="camera-container">
  <video id="video" width="100%" autoplay muted playsinline></video>
  <p id="barcode-result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
</div>

<div id="form-container">
  <label>è©¦è–¬å</label>
  <input type="text" id="reagent-name" placeholder="è©¦è–¬å">
  <label>æ•°é‡</label>
  <input type="number" id="reagent-qty" min="1" value="1">
  <label>æœ‰åŠ¹æœŸé™</label>
  <input type="date" id="reagent-exp">
  <button id="save-btn">ç™»éŒ² / æ›´æ–°</button>
</div>

<h2>ğŸ“¦ åœ¨åº«ä¸€è¦§</h2>
<table id="inventory-table">
  <thead>
    <tr><th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // -------------------------------
  // Firebase åˆæœŸåŒ–
  // -------------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // -------------------------------
  // åœ¨åº«ä¸€è¦§è¡¨ç¤º
  // -------------------------------
  async function refreshInventory() {
    const tbody = document.querySelector('#inventory-table tbody');
    tbody.innerHTML = "";
    const snapshot = await db.collection("reagents").get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${data.name}</td>
        <td>${data.qty}</td>
        <td>${data.expiration}</td>
        <td>${doc.id}</td>
        <td><button class="out-btn" data-id="${doc.id}">å‡ºåº«</button></td>
      `;
      tbody.appendChild(tr);
    });

    // å‡ºåº«ãƒœã‚¿ãƒ³
    document.querySelectorAll('.out-btn').forEach(btn=>{
      btn.onclick = async ()=>{
        const docRef = db.collection("reagents").doc(btn.dataset.id);
        const docSnap = await docRef.get();
        if(docSnap.exists){
          const newQty = Math.max(docSnap.data().qty - 1, 0);
          await docRef.update({ qty:newQty, updated_at:new Date().toISOString() });
          alert(docSnap.data().name + " ã‚’å‡ºåº«ã—ã¾ã—ãŸ (æ®‹ã‚Š: " + newQty + ")");
          refreshInventory();
        }
      };
    });
  }
  refreshInventory();

  // -------------------------------
  // QuaggaJS åˆæœŸåŒ–
  // -------------------------------
  const statusElem = document.getElementById('barcode-result');
  let lastCode = "";
  let cooldown = false;

  Quagga.init({
    inputStream: { type:"LiveStream", constraints:{facingMode:"environment"}, target:document.querySelector('#camera-container') },
    decoder: { readers:["code_128_reader","ean_reader","upc_reader"] }
  }, function(err){
    if(err){ statusElem.textContent = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err; return; }
    Quagga.start();
  });

  Quagga.onDetected(async function(data){
    const code = data.codeResult.code;
    if(code === lastCode || cooldown) return;
    lastCode = code;
    cooldown = true;
    setTimeout(()=>{ cooldown=false; }, 2000);
    statusElem.textContent = "æ¤œå‡º: " + code;

    const form = document.getElementById('form-container');
    form.style.display = "block";

    const docRef = db.collection("reagents").doc(code);
    const doc = await docRef.get();
    if(doc.exists){
      const d = doc.data();
      document.getElementById('reagent-name').value = d.name;
      document.getElementById('reagent-qty').value = 1;
      document.getElementById('reagent-exp').value = d.expiration;
    } else {
      document.getElementById('reagent-name').value = "";
      document.getElementById('reagent-qty').value = 1;
      document.getElementById('reagent-exp').value = "";
    }

    // ä¿å­˜ãƒœã‚¿ãƒ³
    const btn = document.getElementById('save-btn');
    btn.onclick = async () => {
      const name = document.getElementById('reagent-name').value;
      const qty = parseInt(document.getElementById('reagent-qty').value);
      const exp = document.getElementById('reagent-exp').value;
      if(!name || !exp){ alert("åå‰ã¨æœ‰åŠ¹æœŸé™ã¯å¿…é ˆã§ã™"); return; }

      const docSnap = await docRef.get();
      if(docSnap.exists){
        await docRef.update({ qty: docSnap.data().qty + qty, updated_at: new Date().toISOString() });
        alert(name + " ã®æ•°é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      } else {
        await docRef.set({ name:name, qty:qty, expiration:exp, created_at:new Date().toISOString(), updated_at:new Date().toISOString() });
        alert(name + " ã‚’ç™»éŒ²ã—ã¾ã—ãŸ");
      }
      form.style.display = "none";
      refreshInventory();
    };
  });
</script>
</body>
</html>
