<!DOCTYPE html>
<html>
<head>
  <title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 20px; }
    #scanner { width: 480px; margin: auto; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
    button { padding: 6px 12px; margin: 2px; }
  </style>
</head>
<body>

<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶å®Œçµï¼‰</h1>

<div id="scanner">
  <video id="video" autoplay muted playsinline></video>
  <p id="result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
</div>

<div id="form" style="display:none; margin-top:20px;">
  <h3>æ–°è¦è©¦è–¬ç™»éŒ²</h3>
  <input id="name" placeholder="è©¦è–¬å">
  <input type="number" id="qty" value="1" min="1" max="100">
  <input type="date" id="exp">
  <button onclick="register()">ç™»éŒ²</button>
</div>

<h3>åœ¨åº«ä¸€è¦§</h3>
<table id="inventory">
  <thead><tr><th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>å‡ºåº«</th></tr></thead>
  <tbody></tbody>
</table>

<script>
  // -------------------------------
  // Firebase è¨­å®šï¼ˆã‚³ãƒ”ãƒ¼ã—ãŸã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã‚‹ï¼‰
  // -------------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let lastCode = '';
  let cooldown = 3000;
  let lastScanTime = 0;

  // -------------------------------
  // QuaggaJS åˆæœŸåŒ–
  // -------------------------------
  Quagga.init({
    inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#scanner') },
    decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
  }, err => { if(err) console.error(err); else Quagga.start(); });

  Quagga.onDetected(data => {
    const code = data.codeResult.code;
    const now = Date.now();
    if(code === lastCode && now - lastScanTime < cooldown) return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
    lastCode = code;
    lastScanTime = now;

    document.getElementById('result').innerText = "æ¤œå‡º: " + code;

    // Firebaseã§æ—¢å­˜ç¢ºèª
    db.collection("reagents").where("barcode","==",code).get().then(snapshot => {
      if(!snapshot.empty){
        const doc = snapshot.docs[0];
        if(confirm(`${doc.data().name} ã§ã™ã‹ï¼Ÿ`)){
          // æ•°é‡ +1
          doc.ref.update({ qty: doc.data().qty + 1 });
          updateInventory();
        }
      } else {
        // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        document.getElementById('form').style.display = 'block';
        document.getElementById('name').value = '';
        document.getElementById('qty').value = 1;
        document.getElementById('exp').value = '';
        document.getElementById('form').dataset.barcode = code;
      }
    });
  });

  function register(){
    const code = document.getElementById('form').dataset.barcode;
    const name = document.getElementById('name').value;
    const qty = parseInt(document.getElementById('qty').value);
    const exp = document.getElementById('exp').value;
    if(!name || !exp) { alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    db.collection("reagents").add({ barcode: code, name, qty, expiration: exp });
    document.getElementById('form').style.display = 'none';
    updateInventory();
  }

  function updateInventory(){
    db.collection("reagents").get().then(snapshot => {
      const tbody = document.querySelector("#inventory tbody");
      tbody.innerHTML = '';
      snapshot.docs.forEach(doc => {
        const data = doc.data();
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${data.name}</td><td>${data.qty}</td><td>${data.expiration}</td>
                        <td><button onclick="outStock('${doc.id}')">å‡ºåº«</button></td>`;
        tbody.appendChild(tr);
      });
    });
  }

  function outStock(id){
    const docRef = db.collection("reagents").doc(id);
    docRef.get().then(doc => {
      const newQty = Math.max(doc.data().qty - 1, 0);
      docRef.update({ qty: newQty });
      updateInventory();
    });
  }

  updateInventory();

</script>

</body>
</html>
