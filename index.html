<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<style>
  body { font-family: sans-serif; margin:0; padding:0; background:#f0f0f0; }
  #scannerContainer { width:100%; max-width:480px; margin: 1rem auto; border: 2px solid #333; border-radius: 10px; overflow:hidden; }
  #barcodeResult { font-weight:bold; text-align:center; margin-top:1rem; font-size:1.2rem; }
  .form-group { margin: 1rem; }
  label { display:block; margin-bottom:0.3rem; font-weight:bold; }
  input, select, button { width:100%; padding:0.5rem; font-size:1rem; margin-bottom:0.5rem; }
  table { width: 90%; margin:1rem auto; border-collapse: collapse; }
  th, td { border:1px solid #333; padding:0.5rem; text-align:center; }
  button { cursor:pointer; background:#007bff; color:#fff; border:none; border-radius:5px; }
</style>
</head>
<body>

<div id="scannerPage">
  <h2 style="text-align:center;">ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
  <div id="scannerContainer"></div>
  <p id="barcodeResult">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>

  <div id="registrationForm" style="display:none;">
    <div class="form-group">
      <label>è©¦è–¬å</label>
      <input type="text" id="reagentName">
    </div>
    <div class="form-group">
      <label>æ•°é‡</label>
      <input type="number" id="reagentQty" min="1" value="1">
    </div>
    <div class="form-group">
      <label>æœ‰åŠ¹æœŸé™</label>
      <input type="date" id="reagentExp">
    </div>
    <button id="registerBtn">ç™»éŒ²</button>
  </div>
</div>

<div id="inventoryPage" style="display:none;">
  <h2 style="text-align:center;">ğŸ“¦ åœ¨åº«ä¸€è¦§</h2>
  <table id="inventoryTable">
    <thead>
      <tr><th>åå‰</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <button onclick="goBack()">ğŸ”™ ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
</div>

<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
// ---------------------------
// Firebase è¨­å®š
// ---------------------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------------------
// çŠ¶æ…‹ç®¡ç†
// ---------------------------
let lastCode = "";
let cooldown = false;

// ---------------------------
// QuaggaJS åˆæœŸåŒ–
// ---------------------------
Quagga.init({
  inputStream: {
    type: "LiveStream",
    target: document.querySelector('#scannerContainer'),
    constraints: { facingMode: "environment" }
  },
  decoder: { readers:["code_128_reader","ean_reader","upc_reader"] },
  locate:true
}, function(err){
  if(err) { console.error(err); document.getElementById('barcodeResult').textContent = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼"; return; }
  Quagga.start();
});

Quagga.onDetected(async function(result){
  const code = result.codeResult.code;
  if(cooldown || code === lastCode) return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³ã¾ãŸã¯åŒã˜ã‚³ãƒ¼ãƒ‰é€£ç¶šã‚¹ã‚­ãƒƒãƒ—
  lastCode = code;
  cooldown = true;
  setTimeout(()=>{cooldown=false}, 2000); // 2ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

  document.getElementById('barcodeResult').textContent = "æ¤œå‡º: " + code;

  // ---------------------------
  // Firebase ã§æ—¢å­˜ç¢ºèª
  // ---------------------------
  const query = await db.collection("reagents").where("barcode","==",code).get();
  if(!query.empty){
    const data = query.docs[0].data();
    if(confirm(`æ—¢å­˜ã®è©¦è–¬ã§ã™: ${data.name}ï¼ˆæ•°é‡: ${data.qty}ï¼‰\nã“ã®å•†å“ã«è¿½åŠ ã—ã¾ã™ã‹ï¼Ÿ`)){
      // æ•°é‡ +1
      await db.collection("reagents").doc(query.docs[0].id).update({
        qty: data.qty + 1,
        updated_at: new Date()
      });
      alert(`${data.name} ã®æ•°é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼ˆæ®‹ã‚Š: ${data.qty+1}ï¼‰`);
      showInventory();
    }
  } else {
    // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
    document.getElementById('registrationForm').style.display = "block";
    document.getElementById('registerBtn').onclick = async function(){
      const name = document.getElementById('reagentName').value;
      const qty = parseInt(document.getElementById('reagentQty').value);
      const exp = document.getElementById('reagentExp').value;
      if(!name || !qty || !exp){ alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
      await db.collection("reagents").add({
        barcode: code, name, qty, expiration: exp, created_at: new Date(), updated_at: new Date()
      });
      alert(`${name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
      showInventory();
    }
  }
});

// ---------------------------
// åœ¨åº«è¡¨ç¤º
// ---------------------------
async function showInventory(){
  document.getElementById('scannerPage').style.display = "none";
  document.getElementById('inventoryPage').style.display = "block";
  const tbody = document.querySelector("#inventoryTable tbody");
  tbody.innerHTML = "";
  const snapshot = await db.collection("reagents").get();
  snapshot.forEach(doc=>{
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `<td>${data.name}</td><td>${data.qty}</td><td>${data.expiration}</td><td>${data.barcode}</td>
      <td><button onclick="decreaseQty('${doc.id}', ${data.qty})">å‡ºåº«</button></td>`;
    tbody.appendChild(tr);
  });
}

// å‡ºåº«å‡¦ç†
async function decreaseQty(id, qty){
  if(qty <=0 ) return;
  await db.collection("reagents").doc(id).update({qty: qty-1, updated_at: new Date()});
  showInventory();
}

// æˆ»ã‚‹
function goBack(){
  document.getElementById('inventoryPage').style.display="none";
  document.getElementById('scannerPage').style.display="block";
  document.getElementById('registrationForm').style.display="none";
  lastCode = ""; // æ–°ã—ã„ã‚¹ã‚­ãƒ£ãƒ³å—ã‘ä»˜ã‘
}
</script>
</body>
</html>
