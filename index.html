<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
body { font-family: sans-serif; margin:0; padding:0; }
.container { max-width:480px; margin:auto; padding:1rem; }
h1 { font-size:1.5rem; text-align:center; }
button { font-size:1rem; padding:0.5rem 1rem; margin:0.5rem 0; }
input, select { font-size:1rem; padding:0.3rem; width:100%; margin:0.5rem 0; }
#inventoryTable { width:100%; border-collapse: collapse; margin-top:1rem; }
#inventoryTable th, #inventoryTable td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
</style>
</head>
<body>
<div class="container">
<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="scannerPage">
  <div id="barcode-scanner" style="width:100%; margin:auto;">
    <video id="video" width="100%" autoplay muted playsinline></video>
    <p id="barcode-result" style="font-weight:bold; text-align:center; margin-top:1rem;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
  </div>

  <div id="registerForm" style="display:none;">
    <h2>æ–°è¦ç™»éŒ²</h2>
    <input type="text" id="reagentName" placeholder="è©¦è–¬å">
    <input type="number" id="reagentQty" min="1" value="1">
    <input type="date" id="reagentExp">
    <button type="button" id="registerBtn">ç™»éŒ²</button>
  </div>

  <div id="confirmExisting" style="display:none;">
    <p id="existingText"></p>
    <button type="button" id="yesBtn">ã¯ã„</button>
    <button type="button" id="noBtn">ã„ã„ãˆ</button>
  </div>
</div>

<div id="inventoryPage" style="display:none;">
  <h2>åœ¨åº«ä¸€è¦§</h2>
  <table id="inventoryTable">
    <thead><tr><th>åå‰</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr></thead>
    <tbody></tbody>
  </table>
  <button type="button" id="backBtn">ã‚¹ã‚­ãƒ£ãƒ³ãƒšãƒ¼ã‚¸ã¸æˆ»ã‚‹</button>
</div>

<script>
// ------------------ Firebase è¨­å®š ------------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ------------------ å¤‰æ•° ------------------
let lastCode = null;
let cooldown = false;

// ------------------ Quagga åˆæœŸåŒ– ------------------
Quagga.init({
  inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#barcode-scanner') },
  decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
}, function(err){
  if(err){ document.getElementById('barcode-result').textContent = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: "+err; return; }
  Quagga.start();
});

Quagga.onDetected(async function(data){
  const code = data.codeResult.code;
  if(cooldown || code===lastCode) return;
  lastCode = code;
  cooldown = true;
  setTimeout(()=>{ cooldown=false; },3000); // 3ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
  document.getElementById('barcode-result').textContent = "æ¤œå‡º: " + code;

  // Firestoreã«ã‚ã‚‹ã‹ç¢ºèª
  const snapshot = await db.collection("reagents").where("barcode","==",code).get();
  if(!snapshot.empty){
    const doc = snapshot.docs[0].data();
    document.getElementById('existingText').textContent = `æ—¢å­˜è©¦è–¬: ${doc.name} ï¼ˆæ•°é‡: ${doc.qty}ï¼‰ã§ã™ã‹ï¼Ÿ`;
    document.getElementById('confirmExisting').style.display = 'block';
  }else{
    document.getElementById('registerForm').style.display='block';
  }
});

// ------------------ ç™»éŒ² ------------------
document.getElementById('registerBtn').onclick = async function(event){
  const name = document.getElementById('reagentName').value;
  const qty = parseInt(document.getElementById('reagentQty').value);
  const exp = document.getElementById('reagentExp').value;
  if(!name || !qty || !exp){ alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
  await db.collection("reagents").add({
    barcode: lastCode, name, qty, expiration: exp, created_at: new Date(), updated_at: new Date()
  });
  alert(`${name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
  showInventory();
}

// ------------------ æ—¢å­˜ yes/no ------------------
document.getElementById('yesBtn').onclick = async function(){
  // ã“ã“ã§æ•°é‡ +1
  const snapshot = await db.collection("reagents").where("barcode","==",lastCode).get();
  const doc = snapshot.docs[0];
  await db.collection("reagents").doc(doc.id).update({
    qty: doc.data().qty+1,
    updated_at: new Date()
  });
  showInventory();
}
document.getElementById('noBtn').onclick = function(){
  document.getElementById('confirmExisting').style.display='none';
  document.getElementById('registerForm').style.display='block';
}

// ------------------ åœ¨åº«ãƒšãƒ¼ã‚¸è¡¨ç¤º ------------------
async function showInventory(){
  document.getElementById('scannerPage').style.display='none';
  document.getElementById('registerForm').style.display='none';
  document.getElementById('confirmExisting').style.display='none';
  document.getElementById('inventoryPage').style.display='block';

  const tbody = document.querySelector('#inventoryTable tbody');
  tbody.innerHTML='';

  const snapshot = await db.collection("reagents").get();
  snapshot.forEach(doc=>{
    const d = doc.data();
    const tr = document.createElement('tr');
    tr.innerHTML=`<td>${d.name}</td><td>${d.qty}</td><td>${d.expiration}</td><td>${d.barcode}</td>
    <td><button type="button">å‡ºåº«</button></td>`;
    tr.querySelector('button').onclick=async function(){
      const newQty = Math.max(d.qty-1,0);
      await db.collection("reagents").doc(doc.id).update({qty:newQty, updated_at:new Date()});
      tr.querySelector('td:nth-child(2)').textContent = newQty;
    }
    tbody.appendChild(tr);
  });
}

// ------------------ æˆ»ã‚‹ ------------------
document.getElementById('backBtn').onclick=function(){
  document.getElementById('scannerPage').style.display='block';
  document.getElementById('inventoryPage').style.display='none';
}
</script>
</body>
</html>
