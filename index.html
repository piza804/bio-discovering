<!DOCTYPE html>
<html>
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 20px; background: #f5f5f5; }
    h1,h3 { text-align: center; }
    #scanner { width: 90%; max-width: 480px; margin: 0 auto; }
    #result { font-size: 1.5rem; text-align: center; margin: 10px 0; }
    #form { display:none; margin: 20px auto; padding: 20px; max-width: 400px; background:#fff; border-radius:10px; box-shadow:0 2px 5px rgba(0,0,0,0.2);}
    #form input, #form button { width: 100%; padding: 12px; margin: 8px 0; font-size: 1.2rem; }
    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
    th, td { border: 1px solid #ccc; padding: 12px; text-align: center; font-size: 1.2rem; }
    button { cursor: pointer; }
    .page { display: none; }
    .active { display: block; }
  </style>
</head>
<body>

<div id="scanPage" class="page active">
  <h1>ğŸ§ª ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h1>
  <div id="scanner">
    <video id="video" autoplay muted playsinline></video>
    <p id="result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
  </div>

  <div id="form">
    <h3>æ–°è¦è©¦è–¬ç™»éŒ²</h3>
    <input id="name" placeholder="è©¦è–¬å">
    <input type="number" id="qty" value="1" min="1" max="100">
    <input type="date" id="exp">
    <button onclick="register()">ç™»éŒ²</button>
  </div>
</div>

<div id="inventoryPage" class="page">
  <h1>ğŸ“¦ åœ¨åº«ä¸€è¦§</h1>
  <table id="inventory">
    <thead><tr><th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>å‡ºåº«</th></tr></thead>
    <tbody></tbody>
  </table>
  <button onclick="backToScan()" style="margin-top:20px; padding:12px; font-size:1.2rem;">ã‚¹ã‚­ãƒ£ãƒ³ã«æˆ»ã‚‹</button>
</div>

<script>
  // -------------------------------
  // Firebase è¨­å®šï¼ˆã‚³ãƒ”ãƒ¼ã—ãŸã‚³ãƒ¼ãƒ‰ã«ç½®ãæ›ãˆã‚‹ï¼‰
  // -------------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let lastCode = '';
  let cooldown = 3000;
  let lastScanTime = 0;
  let confirmedCode = null;

  const scanPage = document.getElementById('scanPage');
  const inventoryPage = document.getElementById('inventoryPage');

  function showPage(page) {
    scanPage.classList.remove('active');
    inventoryPage.classList.remove('active');
    page.classList.add('active');
  }

  // -------------------------------
  // QuaggaJS åˆæœŸåŒ–
  // -------------------------------
  Quagga.init({
    inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#scanner') },
    decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
  }, err => { if(err) console.error(err); else Quagga.start(); });

  Quagga.onDetected(data => {
    const code = data.codeResult.code;
    const now = Date.now();
    if(code === lastCode && now - lastScanTime < cooldown) return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
    lastCode = code;
    lastScanTime = now;

    document.getElementById('result').innerText = "æ¤œå‡º: " + code;

    if(confirmedCode === code) return; // æ—¢ã«ç¢ºèªæ¸ˆã¿ãªã‚‰ã‚¹ã‚­ãƒƒãƒ—

    // Firebaseã§æ—¢å­˜ç¢ºèª
    db.collection("reagents").where("barcode","==",code).get().then(snapshot => {
      if(!snapshot.empty){
        const doc = snapshot.docs[0];
        if(confirm(`${doc.data().name} ã§ã™ã‹ï¼Ÿ`)){
          // æ•°é‡ +1
          doc.ref.update({ qty: doc.data().qty + 1 }).then(() => {
            confirmedCode = code; // 1å›ã ã‘ç¢ºèª
            alert("æ•°é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
            showInventory();
          });
        }
      } else {
        // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
        document.getElementById('form').style.display = 'block';
        document.getElementById('name').value = '';
        document.getElementById('qty').value = 1;
        document.getElementById('exp').value = '';
        document.getElementById('form').dataset.barcode = code;
      }
    });
  });

  function register(){
    const code = document.getElementById('form').dataset.barcode;
    const name = document.getElementById('name').value;
    const qty = parseInt(document.getElementById('qty').value);
    const exp = document.getElementById('exp').value;
    if(!name || !exp) { alert("å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
    db.collection("reagents").add({ barcode: code, name, qty, expiration: exp }).then(() => {
      document.getElementById('form').style.display = 'none';
      showInventory();
    });
  }

  function showInventory(){
    updateInventory().then(() => showPage(inventoryPage));
  }

  function backToScan(){
    confirmedCode = null;
    lastCode = '';
    showPage(scanPage);
  }

  async function updateInventory(){
    const tbody = document.querySelector("#inventory tbody");
    tbody.innerHTML = '';
    const snapshot = await db.collection("reagents").get();
    snapshot.docs.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${data.name}</td><td>${data.qty}</td><td>${data.expiration}</td>
                      <td><button onclick="outStock('${doc.id}')">å‡ºåº«</button></td>`;
      tbody.appendChild(tr);
    });
  }

  function outStock(id){
    const docRef = db.collection("reagents").doc(id);
    docRef.get().then(doc => {
      const newQty = Math.max(doc.data().qty - 1, 0);
      docRef.update({ qty: newQty }).then(updateInventory);
    });
  }

  updateInventory();
</script>

</body>
</html>
