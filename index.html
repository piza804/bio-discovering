<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<style>
  body { font-family: Arial, sans-serif; margin:0; padding:0; }
  h1,h2 { text-align:center; }
  #scanner, #inventory { display:none; padding:10px; }
  video { width: 100%; max-width: 480px; margin:auto; display:block; }
  input, button, select { font-size:1.2em; padding:0.5em; margin:0.5em 0; width:100%; max-width:480px; }
  .container { display:flex; flex-direction:column; align-items:center; }
  table { width:90%; max-width:480px; border-collapse: collapse; margin: 1em 0; }
  th, td { border:1px solid #333; padding:0.5em; text-align:center; }
  @media (max-width:480px){
    input, button, select, table { font-size:1em; }
  }
</style>
</head>
<body>

<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="scanner" class="container">
  <h2>ğŸ“· ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
  <video id="video" autoplay muted playsinline></video>
  <p id="barcodeResult" style="font-weight:bold;">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>

  <div id="newForm" style="display:none;">
    <h3>æ–°è¦ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç™»éŒ²</h3>
    <input type="text" id="reagentName" placeholder="è©¦è–¬å">
    <input type="number" id="reagentQty" min="1" value="1">
    <input type="date" id="reagentExp">
    <button id="registerBtn">ç™»éŒ²</button>
  </div>

  <div id="existingConfirm" style="display:none;">
    <p id="existingText"></p>
    <button id="yesBtn">ã¯ã„</button>
    <button id="noBtn">ã„ã„ãˆ</button>
  </div>
</div>

<div id="inventory" class="container">
  <h2>ğŸ“¦ åœ¨åº«ä¸€è¦§</h2>
  <table>
    <thead><tr><th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>å‡ºåº«</th></tr></thead>
    <tbody id="inventoryTable"></tbody>
  </table>
  <button id="backBtn">ã‚¹ã‚­ãƒ£ãƒ³ã«æˆ»ã‚‹</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<!-- QuaggaJS -->
<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>

<script>
  // -------------------------------
  // Firebase åˆæœŸåŒ–
  // -------------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // -------------------------------
  // è¦ç´ å–å¾—
  // -------------------------------
  const scannerDiv = document.getElementById("scanner");
  const inventoryDiv = document.getElementById("inventory");
  const video = document.getElementById("video");
  const barcodeResult = document.getElementById("barcodeResult");
  const newForm = document.getElementById("newForm");
  const existingConfirm = document.getElementById("existingConfirm");
  const existingText = document.getElementById("existingText");
  const registerBtn = document.getElementById("registerBtn");
  const yesBtn = document.getElementById("yesBtn");
  const noBtn = document.getElementById("noBtn");
  const inventoryTable = document.getElementById("inventoryTable");
  const backBtn = document.getElementById("backBtn");

  let lastBarcode = "";
  let cooldown = false;

  function showScanner() {
    scannerDiv.style.display = "flex";
    inventoryDiv.style.display = "none";
    newForm.style.display = "none";
    existingConfirm.style.display = "none";
    barcodeResult.textContent = "ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º";
  }

  function showInventory() {
    scannerDiv.style.display = "none";
    inventoryDiv.style.display = "flex";
    loadInventory();
  }

  // -------------------------------
  // åœ¨åº«èª­ã¿è¾¼ã¿
  // -------------------------------
  function loadInventory(){
    inventoryTable.innerHTML = "";
    db.collection("reagents").get().then(snapshot=>{
      snapshot.forEach(doc=>{
        const data = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.name}</td>
          <td>${data.qty}</td>
          <td>${data.expiration || ""}</td>
          <td><button onclick="decrementQty('${doc.id}', ${data.qty})">å‡ºåº«</button></td>
        `;
        inventoryTable.appendChild(tr);
      });
    });
  }

  window.decrementQty = function(id, currentQty){
    const newQty = Math.max(currentQty - 1, 0);
    db.collection("reagents").doc(id).update({qty:newQty});
    loadInventory();
  }

  // -------------------------------
  // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æ¤œå‡ºå‡¦ç†
  // -------------------------------
  function handleBarcode(code){
    if(cooldown || code === lastBarcode) return;
    cooldown = true;
    lastBarcode = code;
    barcodeResult.textContent = "æ¤œå‡º: " + code;

    db.collection("reagents").where("barcode","==",code).get().then(snapshot=>{
      if(snapshot.empty){
        newForm.style.display = "flex";
      } else {
        const data = snapshot.docs[0].data();
        existingText.textContent = `æ—¢å­˜ç™»éŒ²ãŒã‚ã‚Šã¾ã™: ${data.name}ï¼ˆæ•°é‡: ${data.qty}ï¼‰ ã“ã®å•†å“ã§ã™ã‹ï¼Ÿ`;
        existingConfirm.style.display = "flex";

        yesBtn.onclick = ()=>{
          db.collection("reagents").doc(snapshot.docs[0].id).update({qty:data.qty+1}).then(()=>{
            cooldown = false;
            showInventory();
          });
        };
        noBtn.onclick = ()=>{
          cooldown = false;
          newForm.style.display = "flex";
          existingConfirm.style.display = "none";
        };
      }
    });
  }

  registerBtn.onclick = ()=>{
    const name = document.getElementById("reagentName").value;
    const qty = parseInt(document.getElementById("reagentQty").value);
    const exp = document.getElementById("reagentExp").value;
    db.collection("reagents").add({
      barcode:lastBarcode, name:name, qty:qty, expiration:exp
    }).then(()=> showInventory());
  };

  backBtn.onclick = showScanner;

  // -------------------------------
  // QuaggaJS åˆæœŸåŒ–
  // -------------------------------
  Quagga.init({
    inputStream:{type:"LiveStream", target:video, constraints:{facingMode:"environment"}},
    decoder:{readers:["code_128_reader","ean_reader","upc_reader"]}
  }, function(err){
    if(err){ alert("ã‚«ãƒ¡ãƒ©èµ·å‹•ã‚¨ãƒ©ãƒ¼:"+err); return; }
    Quagga.start();
  });

  Quagga.onDetected((data)=>{
    handleBarcode(data.codeResult.code);
    setTimeout(()=>{ cooldown=false; }, 1500); // 1.5ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
  });

  // åˆæœŸè¡¨ç¤º
  showScanner();
</script>
</body>
</html>
