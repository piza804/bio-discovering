<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
  <style>
    body { font-family: sans-serif; max-width: 800px; margin:auto; }
    video { width:100%; border:1px solid #ccc; }
    .barcode-result { font-weight:bold; margin: 1rem 0; }
    .hidden { display:none; }
    table { width:100%; border-collapse: collapse; margin-top:1rem; }
    th, td { border:1px solid #ccc; padding:5px; text-align:center; }
    button { margin:2px; }
  </style>
</head>
<body>

<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="scanner">
  <video id="video" autoplay muted playsinline></video>
  <p id="barcode-result" class="barcode-result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
</div>

<div id="form-area" class="hidden">
  <h2>æ–°è¦è©¦è–¬ç™»éŒ²</h2>
  <label>è©¦è–¬å: <input type="text" id="name"></label><br>
  <label>æ•°é‡: <input type="number" id="qty" value="1"></label><br>
  <label>æœ‰åŠ¹æœŸé™: <input type="date" id="exp"></label><br>
  <button id="register-btn">ç™»éŒ²</button>
</div>

<h2>åœ¨åº«ä¸€è¦§</h2>
<table id="inventory">
  <thead><tr><th>åå‰</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>æ“ä½œ</th></tr></thead>
  <tbody></tbody>
</table>

<script>
  // -------------------------------
  // Firebase åˆæœŸåŒ–ï¼ˆè‡ªåˆ†ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆè¨­å®šã«ç½®ãæ›ãˆï¼‰
  // -------------------------------
  const firebaseConfig = {
    apiKey: "API_KEY",
    authDomain: "PROJECT_ID.firebaseapp.com",
    projectId: "PROJECT_ID",
    storageBucket: "PROJECT_ID.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  let lastBarcode = "";

  // -------------------------------
  // QuaggaJSã§ã‚¹ã‚­ãƒ£ãƒ³
  // -------------------------------
  Quagga.init({
    inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#scanner') },
    decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
  }, function(err){
    if(err){ console.log(err); return; }
    Quagga.start();
  });

  Quagga.onDetected(async function(data){
    const code = data.codeResult.code;
    if(code === lastBarcode) return; // é‡è¤‡æ¤œå‡ºå›é¿
    lastBarcode = code;
    document.getElementById("barcode-result").textContent = "æ¤œå‡º: " + code;

    const query = await db.collection("reagents").where("barcode","==",code).get();
    if(!query.empty){
      // æ—¢å­˜è©¦è–¬ â†’ æ•°é‡ãƒœã‚¿ãƒ³è¡¨ç¤º
      const doc = query.docs[0];
      const qty = doc.data().qty;
      if(confirm(`${doc.data().name}ï¼ˆæ®‹ã‚Š: ${qty}ï¼‰ã«+1ã—ã¾ã™ã‹ï¼Ÿ`)){
        db.collection("reagents").doc(doc.id).update({ qty: qty+1 });
        loadInventory();
      }
    }else{
      // æ–°è¦ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
      document.getElementById("form-area").classList.remove("hidden");
      document.getElementById("register-btn").onclick = function(){
        const name = document.getElementById("name").value;
        const qty = parseInt(document.getElementById("qty").value);
        const exp = document.getElementById("exp").value;
        db.collection("reagents").add({ barcode: code, name, qty, expiration: exp });
        document.getElementById("form-area").classList.add("hidden");
        loadInventory();
      };
    }
  });

  // -------------------------------
  // åœ¨åº«ä¸€è¦§è¡¨ç¤º
  // -------------------------------
  async function loadInventory(){
    const tbody = document.querySelector("#inventory tbody");
    tbody.innerHTML = "";
    const snapshot = await db.collection("reagents").get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${data.name}</td>
        <td>${data.qty}</td>
        <td>${data.expiration || ""}</td>
        <td>${data.barcode}</td>
        <td><button onclick="updateQty('${doc.id}', ${data.qty})">å‡ºåº« -1</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  async function updateQty(id, currentQty){
    const newQty = Math.max(currentQty-1,0);
    await db.collection("reagents").doc(id).update({ qty: newQty });
    loadInventory();
  }

  loadInventory();
</script>
</body>
</html>
