<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  #scanner { width: 100%; max-width: 480px; margin:auto; }
  video { width: 100%; }
  .info { font-weight: bold; margin-top: 1rem; text-align:center; }
  input, button { display:block; margin: 0.5rem auto; width:90%; max-width:300px; padding:0.5rem; }
</style>
</head>
<body>

<h1 style="text-align:center;">ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="scanner">
  <video autoplay muted playsinline></video>
  <p class="info" id="barcode-status">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
</div>

<div id="form-container" style="display:none;">
  <h2 style="text-align:center;">è©¦è–¬æƒ…å ±</h2>
  <input type="text" id="reagent-name" placeholder="è©¦è–¬å">
  <input type="number" id="reagent-qty" placeholder="æ•°é‡" value="1" min="1">
  <input type="date" id="reagent-exp">
  <button id="register-btn">ç™»éŒ² / æ•°é‡æ›´æ–°</button>
</div>

<h2 style="text-align:center;">åœ¨åº«ä¸€è¦§</h2>
<table border="1" style="width:90%; max-width:600px; margin:auto; text-align:center;">
  <thead><tr><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>æ›´æ–°</th></tr></thead>
  <tbody id="reagent-table"></tbody>
</table>

<script>
  // ---------------- Firebase åˆæœŸåŒ– ----------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ---------------- QuaggaJS ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ ----------------
  const statusElem = document.getElementById("barcode-status");
  let lastCode = "";

  Quagga.init({
    inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#scanner') },
    decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
  }, function(err) {
    if(err){ statusElem.textContent = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err; return; }
    Quagga.start();
  });

  Quagga.onDetected(async function(data){
    const code = data.codeResult.code;
    if(code === lastCode) return; // ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³
    lastCode = code;
    statusElem.textContent = "æ¤œå‡º: " + code;
    checkReagent(code);
  });

  // ---------------- ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç¢ºèªãƒ»ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º ----------------
  async function checkReagent(barcode){
    const doc = await db.collection("reagents").doc(barcode).get();
    const form = document.getElementById("form-container");
    if(doc.exists){
      const data = doc.data();
      document.getElementById("reagent-name").value = data.name;
      document.getElementById("reagent-qty").value = 1;
      document.getElementById("reagent-exp").value = data.expiration;
      form.style.display = "block";
    } else {
      // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ 
      document.getElementById("reagent-name").value = "";
      document.getElementById("reagent-qty").value = 1;
      document.getElementById("reagent-exp").value = "";
      form.style.display = "block";
    }
  }

  // ---------------- ç™»éŒ² / æ•°é‡æ›´æ–° ----------------
  document.getElementById("register-btn").addEventListener("click", async () => {
    const name = document.getElementById("reagent-name").value;
    const qty = parseInt(document.getElementById("reagent-qty").value);
    const exp = document.getElementById("reagent-exp").value;
    if(!lastCode || !name || !qty || !exp) return alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„");

    const docRef = db.collection("reagents").doc(lastCode);
    const doc = await docRef.get();
    if(doc.exists){
      // æ—¢å­˜ãªã‚‰æ•°é‡åŠ ç®—
      const newQty = doc.data().qty + qty;
      await docRef.update({ qty: newQty, updated_at: new Date() });
    } else {
      // æ–°è¦ç™»éŒ²
      await docRef.set({ barcode: lastCode, name: name, qty: qty, expiration: exp, created_at: new Date(), updated_at: new Date() });
    }
    form.style.display = "none";
    lastCode = "";
    loadTable();
  });

  // ---------------- åœ¨åº«ä¸€è¦§è¡¨ç¤º ----------------
  async function loadTable(){
    const tbody = document.getElementById("reagent-table");
    tbody.innerHTML = "";
    const snapshot = await db.collection("reagents").get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${doc.id}</td>
        <td>${data.name}</td>
        <td>${data.qty}</td>
        <td>${data.expiration}</td>
        <td><button onclick="updateQty('${doc.id}')">+1</button></td>
      `;
      tbody.appendChild(tr);
    });
  }

  window.updateQty = async function(barcode){
    const docRef = db.collection("reagents").doc(barcode);
    const doc = await docRef.get();
    if(doc.exists){
      const newQty = doc.data().qty + 1;
      await docRef.update({ qty: newQty, updated_at: new Date() });
      loadTable();
    }
  }

  loadTable();
</script>

</body>
</html>
