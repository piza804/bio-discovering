<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.24.0/firebase-firestore-compat.js"></script>
<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
<style>
body { font-family: sans-serif; max-width: 900px; margin:auto; padding:1rem; }
#barcode-scanner { width:100%; max-width:480px; margin:auto; border:1px solid #ccc; }
#barcode-result { font-weight:bold; text-align:center; margin:1rem 0; font-size:1.2rem; }
#form-area.hidden { display:none; }
table { width:100%; border-collapse: collapse; margin-top:1rem; }
th, td { border:1px solid #ccc; padding:0.5rem; text-align:center; }
button { padding:0.3rem 0.6rem; font-size:1rem; }
</style>
</head>
<body>

<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="barcode-scanner">
  <video id="video" autoplay muted playsinline></video>
  <p id="barcode-result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
</div>

<div id="form-area" class="hidden">
  <h3>æ–°è¦ç™»éŒ²</h3>
  <label>è©¦è–¬å: <input type="text" id="name"></label><br><br>
  <label>æ•°é‡: <input type="number" id="qty" value="1" min="1"></label><br><br>
  <label>æœ‰åŠ¹æœŸé™: <input type="date" id="exp"></label><br><br>
  <button id="register-btn">ç™»éŒ²</button>
</div>

<h2>åœ¨åº«ä¸€è¦§</h2>
<table id="inventory">
<thead>
<tr>
  <th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>å‡ºåº«</th>
</tr>
</thead>
<tbody></tbody>
</table>

<script>
// ---------------- Firebase åˆæœŸåŒ– ----------------
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT_ID.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// ---------------- QuaggaJS ----------------
let lastBarcode = "";
Quagga.init({
  inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#barcode-scanner') },
  decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
}, function(err){
  if(err) document.getElementById('barcode-result').textContent = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: " + err;
  else Quagga.start();
});

Quagga.onDetected(async function(data){
  const code = data.codeResult.code;
  if(code === lastBarcode) return;
  lastBarcode = code;
  document.getElementById("barcode-result").textContent = "æ¤œå‡º: " + code;

  const query = await db.collection("reagents").where("barcode","==",code).get();
  if(!query.empty){
    const doc = query.docs[0];
    const data = doc.data();
    if(confirm(`"${data.name}"ï¼ˆæ®‹ã‚Š: ${data.qty}ï¼‰ã§ã™ã‹ï¼Ÿ`)){
      await db.collection("reagents").doc(doc.id).update({ qty: data.qty + 1 });
      loadInventory();
    }
  }else{
    document.getElementById("form-area").classList.remove("hidden");
    document.getElementById("register-btn").onclick = async function(){
      const name = document.getElementById("name").value;
      const qty = parseInt(document.getElementById("qty").value);
      const exp = document.getElementById("exp").value;
      await db.collection("reagents").add({ barcode: code, name, qty, expiration: exp });
      document.getElementById("form-area").classList.add("hidden");
      document.getElementById("name").value = "";
      document.getElementById("qty").value = 1;
      document.getElementById("exp").value = "";
      loadInventory();
    };
  }
});

// ---------------- åœ¨åº«ä¸€è¦§è¡¨ç¤º ----------------
async function loadInventory(){
  const tbody = document.querySelector("#inventory tbody");
  tbody.innerHTML = "";
  const snapshot = await db.collection("reagents").get();
  snapshot.forEach(doc => {
    const data = doc.data();
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${data.name}</td>
      <td id="qty-${doc.id}">${data.qty}</td>
      <td>${data.expiration || ""}</td>
      <td>${data.barcode}</td>
      <td><button onclick="updateQty('${doc.id}')">å‡ºåº« -1</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// ---------------- å‡ºåº«å‡¦ç† ----------------
async function updateQty(id){
  const qtyElem = document.getElementById(`qty-${id}`);
  let currentQty = parseInt(qtyElem.textContent);
  if(currentQty <= 0) return;
  const newQty = currentQty - 1;
  await db.collection("reagents").doc(id).update({ qty: newQty });
  qtyElem.textContent = newQty;
}

// åˆæœŸè¡¨ç¤º
loadInventory();
</script>

</body>
</html>
