<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<title>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</title>
<script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<style>
  body { font-family: sans-serif; max-width: 900px; margin:auto; padding:1rem; background:#f5f5f5; }
  #barcode-scanner { width:100%; max-width:480px; margin:auto; text-align:center; }
  video { width:100%; border-radius: 8px; box-shadow:0 2px 8px rgba(0,0,0,0.2);}
  table { width:100%; border-collapse: collapse; margin-top:1rem; }
  th, td { border:1px solid #aaa; padding:0.5rem; text-align:center; }
  th { background:#eee; }
  #form-container { background:#fff; padding:1rem; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); margin-top:1rem; }
  button { padding:0.5rem 1rem; margin-top:0.5rem; border:none; background:#007bff; color:#fff; border-radius:4px; cursor:pointer;}
  button:hover { background:#0056b3; }
</style>
</head>
<body>

<h1>ğŸ§ª è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç®¡ç†</h1>

<div id="barcode-scanner">
  <video id="video" autoplay muted playsinline></video>
  <p id="barcode-result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>
</div>

<div id="form-container" style="display:none;">
  <h2 id="form-title">æ–°è¦è©¦è–¬ç™»éŒ²</h2>
  <label>è©¦è–¬å: <input type="text" id="reagent-name"></label><br>
  <label>æ•°é‡: <input type="number" id="reagent-qty" value="1" min="1"></label><br>
  <label>æœ‰åŠ¹æœŸé™: <input type="date" id="reagent-exp"></label><br>
  <button id="submit-btn">ç™»éŒ² / æ›´æ–°</button>
</div>

<h2 id="inventory-title">ğŸ“¦ åœ¨åº«ä¸€è¦§</h2>
<table id="inventory-table">
  <thead>
    <tr><th>è©¦è–¬å</th><th>æ•°é‡</th><th>æœ‰åŠ¹æœŸé™</th><th>ãƒãƒ¼ã‚³ãƒ¼ãƒ‰</th><th>å‡ºåº«</th></tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // ===== Firebase åˆæœŸåŒ– =====
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_PROJECT.firebaseapp.com",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_PROJECT.appspot.com",
    messagingSenderId: "SENDER_ID",
    appId: "APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // ===== ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³ =====
  const resultElem = document.getElementById('barcode-result');
  Quagga.init({
    inputStream: { type:"LiveStream", constraints:{facingMode:"environment"}, target: document.querySelector('#barcode-scanner') },
    decoder: { readers:["code_128_reader","ean_reader","upc_reader"] }
  }, err => { if(err){ resultElem.textContent="ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: "+err; return; } Quagga.start(); });

  Quagga.onDetected(async function(data){
    const code = data.codeResult.code;
    resultElem.textContent = "æ¤œå‡º: " + code;

    // ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ã§ Firestore ã‚’æ¤œç´¢
    const docRef = db.collection('reagents').doc(code);
    const docSnap = await docRef.get();
    const form = document.getElementById('form-container');
    const title = document.getElementById('form-title');
    document.getElementById('reagent-name').value = '';
    document.getElementById('reagent-qty').value = 1;
    document.getElementById('reagent-exp').value = '';

    if(docSnap.exists){
      // æ—¢å­˜
      title.textContent = `æ—¢å­˜è©¦è–¬: ${docSnap.data().name} æ›´æ–°`;
      document.getElementById('reagent-name').value = docSnap.data().name;
    } else {
      title.textContent = "æ–°è¦è©¦è–¬ç™»éŒ²";
    }

    form.style.display = 'block';

    // ç™»éŒ²/æ›´æ–°ãƒœã‚¿ãƒ³
    const btn = document.getElementById('submit-btn');
    btn.onclick = async () => {
      const name = document.getElementById('reagent-name').value.trim();
      const qty = parseInt(document.getElementById('reagent-qty').value);
      const exp = document.getElementById('reagent-exp').value;
      if(!name || !exp){ alert("åå‰ã¨æœ‰åŠ¹æœŸé™ã¯å¿…é ˆ"); return; }

      if(docSnap.exists){
        await docRef.update({ qty: docSnap.data().qty + qty, updated_at: new Date().toISOString() });
        alert(name + " ã®æ•°é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸ");
      } else {
        await docRef.set({ name:name, qty:qty, expiration:exp, created_at:new Date().toISOString(), updated_at:new Date().toISOString() });
        alert(name + " ã‚’ç™»éŒ²ã—ã¾ã—ãŸ");
      }

      form.style.display = 'none';
      await refreshInventory();
      document.querySelector('#inventory-table').scrollIntoView({ behavior: 'smooth' });
    };
  });

  // ===== åœ¨åº«ä¸€è¦§è¡¨ç¤º =====
  async function refreshInventory(){
    const tbody = document.querySelector('#inventory-table tbody');
    tbody.innerHTML = '';
    const snapshot = await db.collection('reagents').get();
    snapshot.forEach(doc => {
      const data = doc.data();
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${data.name}</td>
                      <td>${data.qty}</td>
                      <td>${data.expiration}</td>
                      <td>${doc.id}</td>
                      <td><button onclick="decreaseQty('${doc.id}')">å‡ºåº«</button></td>`;
      tbody.appendChild(tr);
    });
  }

  async function decreaseQty(id){
    const docRef = db.collection('reagents').doc(id);
    const docSnap = await docRef.get();
    if(docSnap.exists){
      const newQty = Math.max(docSnap.data().qty - 1, 0);
      await docRef.update({ qty:newQty, updated_at:new Date().toISOString() });
      await refreshInventory();
    }
  }

  refreshInventory();
</script>
</body>
</html>
