<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>è©¦è–¬ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç™»éŒ²</title>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@ericblade/quagga2@v0.0.9/dist/quagga.min.js"></script>
  <style>
    body { font-family: sans-serif; margin: 0; padding: 0; }
    .container { padding: 1rem; max-width: 600px; margin: auto; }
    video { width: 100%; border-radius: 10px; }
    input, button { font-size: 1rem; padding: 0.5rem; margin: 0.3rem 0; width: 100%; }
    #barcode-result { font-weight: bold; text-align: center; margin-top: 1rem; font-size: 1.2rem; }
    .form-group { margin-top: 1rem; }
  </style>
</head>
<body>
<div class="container">
  <h1>ğŸ§ª ãƒãƒ¼ã‚³ãƒ¼ãƒ‰ç™»éŒ²</h1>
  <div id="barcode-scanner">
    <video id="video" autoplay muted playsinline></video>
  </div>
  <p id="barcode-result">ãƒãƒ¼ã‚³ãƒ¼ãƒ‰æœªæ¤œå‡º</p>

  <div id="register-form" style="display:none;">
    <div class="form-group">
      <label>è©¦è–¬å:</label>
      <input type="text" id="name">
    </div>
    <div class="form-group">
      <label>æ•°é‡:</label>
      <input type="number" id="qty" value="1" min="1">
    </div>
    <div class="form-group">
      <label>æœ‰åŠ¹æœŸé™:</label>
      <input type="date" id="exp">
    </div>
    <button id="register-btn">ç™»éŒ²</button>
  </div>
</div>

<script>
  // --------------------------
  // Firebase è¨­å®š
  // --------------------------
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --------------------------
  // QuaggaJS ã‚¹ã‚­ãƒ£ãƒ³
  // --------------------------
  let lastCode = "";
  let cooldown = false;

  Quagga.init({
    inputStream: { type: "LiveStream", constraints: { facingMode: "environment" }, target: document.querySelector('#barcode-scanner') },
    decoder: { readers: ["code_128_reader","ean_reader","upc_reader"] }
  }, function(err) {
    if(err){ document.getElementById('barcode-result').innerText = "ã‚«ãƒ¡ãƒ©åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼"; return; }
    Quagga.start();
  });

  Quagga.onDetected(async function(data){
    const code = data.codeResult.code;
    if(cooldown || code === lastCode) return;
    lastCode = code;
    cooldown = true;
    setTimeout(()=>cooldown=false,3000); // 3ç§’ã‚¯ãƒ¼ãƒ«ãƒ€ã‚¦ãƒ³

    const resultElem = document.getElementById('barcode-result');
    resultElem.innerText = "æ¤œå‡º: " + code;

    // Firestore ã§æ—¢å­˜ç¢ºèª
    const snapshot = await db.collection("reagents").where("barcode","==",code).get();
    if(!snapshot.empty){
      const doc = snapshot.docs[0].data();
      if(confirm(`${doc.name} ã¯æ—¢å­˜ã§ã™ã€‚æ•°é‡ã‚’ +1 ã—ã¾ã™ã‹ï¼Ÿ`)){
        await db.collection("reagents").doc(snapshot.docs[0].id).update({
          qty: doc.qty + 1,
          updated_at: new Date()
        });
        alert("æ•°é‡ã‚’æ›´æ–°ã—ã¾ã—ãŸã€‚");
        window.location.href = "inventory.html";
      }
    } else {
      // æ–°è¦ç™»éŒ²ãƒ•ã‚©ãƒ¼ãƒ è¡¨ç¤º
      document.getElementById('register-form').style.display = "block";
      document.getElementById('register-btn').onclick = async ()=>{
        const name = document.getElementById('name').value;
        const qty = parseInt(document.getElementById('qty').value);
        const exp = document.getElementById('exp').value;
        if(!name || !qty || !exp){ alert("å…¨ã¦å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }
        await db.collection("reagents").add({
          barcode: code,
          name: name,
          qty: qty,
          expiration: exp,
          created_at: new Date(),
          updated_at: new Date()
        });
        alert(`${name} ã‚’ç™»éŒ²ã—ã¾ã—ãŸ`);
        window.location.href = "inventory.html";
      }
    }
  });
</script>
</body>
</html>
